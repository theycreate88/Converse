<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f6fa;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #2c3e50;
      color: white;
      position: sticky;
      top: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    .user-info img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    .user-name {
      font-size: 16px;
      font-weight: bold;
    }

    .search-bar input {
      padding: 8px 12px;
      border-radius: 20px;
      border: none;
      outline: none;
      width: 250px;
    }

    .content {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .user-list {
      list-style-type: none;
      padding: 0;
    }

    .user-item {
      background-color: white;
      margin-bottom: 10px;
      padding: 10px;
      display: flex;
      align-items: center;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    .user-item img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    .user-item:hover {
      background-color: #ecf0f1;
    }

    .recent-chats {
      margin-top: 30px;
    }

    .recent-chats h3 {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="user-info">
      <img id="userPic" src="" alt="Profile" />
      <span class="user-name" id="userName">User</span>
    </div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search users by name..." />
    </div>
  </div>

  <div class="content">
    <ul id="userList" class="user-list"></ul>
    <div class="recent-chats">
      <h3>Recent Chats</h3>
      <ul id="recentChatsList" class="user-list"></ul>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWYeGtEkzRczyEMrx9PvjOkry1L5bYgZ0",
      authDomain: "converse-c3aa7.firebaseapp.com",
      projectId: "converse-c3aa7",
      storageBucket: "converse-c3aa7.appspot.com",
      messagingSenderId: "914299700274",
      appId: "1:914299700274:web:22e0f0574168868855282b",
      measurementId: "G-HDFQTPYL31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const name = localStorage.getItem("userName");
    const photo = localStorage.getItem("userPhoto");
    const uid = localStorage.getItem("userUid");

    if (name) {
      document.getElementById("userName").innerText = name;
    }

    if (photo) {
      document.getElementById("userPic").src = photo;
    }

    // Fetch users from Firestore for search functionality
    const fetchUsers = async (query = '') => {
      if (!query) return [];

      const snapshot = await db.collection('users')
        .where("name", ">=", query)
        .where("name", "<=", query + '\uf8ff')
        .get();

      const users = [];
      snapshot.forEach(doc => {
        const userData = doc.data();
        if (userData.uid !== uid) {
          users.push(userData);
        }
      });
      return users;
    };

    // Display searched users
    const displayUsers = async () => {
      const query = document.getElementById('searchInput').value.trim();
      const userList = document.getElementById('userList');
      userList.innerHTML = '';

      if (query === '') return;

      const users = await fetchUsers(query);

      users.forEach(user => {
        const userItem = document.createElement('li');
        userItem.className = 'user-item';
        userItem.innerHTML = `
          <img src="${user.photo}" alt="User Photo" />
          <span>${user.name}</span>
        `;
        userItem.addEventListener('click', () => {
          localStorage.setItem('chatWithName', user.name);
          localStorage.setItem('chatWithUid', user.uid);
          localStorage.setItem('chatWithPhoto', user.photo);
          window.location.href = 'chat.html';
        });
        userList.appendChild(userItem);
      });
    };

    document.getElementById('searchInput').addEventListener('input', displayUsers);

    // Fetch recent chats for the logged-in user
    const fetchRecentChats = async () => {
      const recentChatsList = document.getElementById("recentChatsList");
      const snapshot = await db.collection('users').doc(uid).collection('recentChats').get();

      recentChatsList.innerHTML = '';
      snapshot.forEach(doc => {
        const userData = doc.data();
        const userItem = document.createElement('li');
        userItem.classList.add('user-item');
        userItem.innerHTML = `
          <img src="${userData.photo}" alt="User Photo" />
          ${userData.name}
        `;
        userItem.addEventListener('click', () => {
          localStorage.setItem("chatWithUid", doc.id);
          localStorage.setItem("chatWithName", userData.name);
          localStorage.setItem("chatWithPhoto", userData.photo);
          window.location.href = "chat.html"; // Redirect to chat page
        });
        recentChatsList.appendChild(userItem);
      });
    };

    // Call the functions when the page loads
    fetchRecentChats();
    displayUsers();

  </script>
</body>
</html>
